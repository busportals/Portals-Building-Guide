name: Post Building Guide updates to Discord

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build change summary
        id: summary
        run: |
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          STATS=$(git diff --stat ${{ github.event.before }} ${{ github.event.after }})
          printf "**Changed files:**\n" > summary.md
          for f in $FILES; do printf "â€¢ %s\n" "$f" >> summary.md; done
          printf "\n**Stats:**\n%s" "$STATS" >> summary.md
          printf "message<<EOF\n" >> $GITHUB_OUTPUT
          cat summary.md >> $GITHUB_OUTPUT
          printf "EOF\n" >> $GITHUB_OUTPUT

      - name: Send to Discord
        run: |
          URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          PAYLOAD=$(jq -c \
            --arg title "Building Guide Update" \
            --arg url   "$URL" \
            --arg desc  "${{ steps.summary.outputs.message }}" \
            '{username:"GitBook", embeds:[{title:$title, url:$url, description:$desc}]}')
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"