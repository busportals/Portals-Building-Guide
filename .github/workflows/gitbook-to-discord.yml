name: Post Building Guide updates to Discord

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get commit diff
        id: diff
        run: |
          # Check if valid SHAs are available to avoid empty diff
          if [[ -n "${{ github.event.before }}" && -n "${{ github.event.after }}" ]]; then
            git diff ${{ github.event.before }} ${{ github.event.after }} > diff.txt
          else
            echo "No valid diff available" > diff.txt
          fi
          # Limit diff size to avoid token limits in OpenAI API
          DIFF=$(head -c 10000 diff.txt | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

      - name: Generate AI summary
        id: summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          # Construct OpenAI API request payload
          PAYLOAD=$(jq -nc \
            --arg system "You are a helpful assistant summarizing GitBook updates." \
            --arg user "$DIFF" \
            '{"model":"gpt-3.5-turbo","messages":[{"role":"system","content":$system},{"role":"user","content":$user}],"max_tokens":200,"temperature":0.3}')
          # Call OpenAI chat completions endpoint
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            https://api.openai.com/v1/chat/completions)
          # Extract the summary text
          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          # Output for next steps
          echo "message=$(jq -Rs . <<< \"$SUMMARY\")" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          RAW_MESSAGE: ${{ steps.summary.outputs.message }}
        run: |
          # Strip surrounding JSON quotes and unescape newlines
          RAW_ESCAPED=${RAW_MESSAGE#\"}
          RAW_ESCAPED=${RAW_ESCAPED%\"}
          MESSAGE=$(printf '%b' "$RAW_ESCAPED")
          # Truncate message to fit Discord embed limits
          MESSAGE=$(echo "$MESSAGE" | head -c 2000)
          # Build JSON payload with full description
          PAYLOAD=$(jq -nc \
            --arg username "Portals" \
            --arg title "Building Guide Update" \
            --arg desc "$MESSAGE" \
            '{"username":$username,"embeds":[{"title":$title,"description":$desc,"color":3066993}]}')
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"