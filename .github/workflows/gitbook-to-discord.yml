name: Post Building Guide updates to Discord

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build change summary
        id: summary
        run: |
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          STATS=$(git diff --stat ${{ github.event.before }} ${{ github.event.after }})
          DESC="**Changed files:**\n"
          for f in $FILES; do
            DESC+=$(printf "â€¢ %s\n" "$f")
          done
          DESC+="\n**Stats:**\n$STATS"
          DESC_JSON=$(printf '%s' "$DESC" | jq -Rs '.')
          echo "message=$DESC_JSON" >> $GITHUB_OUTPUT

      - name: Send to Discord
        run: |
          URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          RAW_MESSAGE="${{ steps.summary.outputs.message }}"
          # strip surrounding JSON quotes
          MESSAGE=${RAW_MESSAGE#\"}
          MESSAGE=${MESSAGE%\"}
          # build JSON payload safely, with parentheses and newlines handled
          PAYLOAD=$(jq -nc \
            --arg username "GitBook" \
            --arg title "Building Guide Update" \
            --arg url "$URL" \
            --arg desc "$MESSAGE" \
            '{"username":$username,"embeds":[{"title":$title,"url":$url,"description":$desc}]}')
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"