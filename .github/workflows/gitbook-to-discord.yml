name: Post Building Guide updates to Discord

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get commit diff
        id: diff
        run: |
          git fetch --prune --unshallow
          git diff ${{ github.event.before }} ${{ github.event.after }} > diff.txt
          DIFF=$(sed ':a;N;$!ba;s/\n/\\n/g' diff.txt)
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

      - name: Generate human-friendly summary
        id: explain
        uses: captradeoff/openai-summarize-diff-action@v1.0.0
        with:
          diff: ${{ steps.diff.outputs.diff }}
          apikey: ${{ secrets.OPENAI_API_KEY }}

      - name: Prepare summary
        id: prepare_summary
        run: |
          MESSAGE="${{ steps.explain.outputs.explanation }}"
          MESSAGE_JSON=$(jq -Rs . <<< "$MESSAGE")
          echo "message=$MESSAGE_JSON" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          RAW_MESSAGE: ${{ steps.prepare_summary.outputs.message }}
        run: |
          # Strip surrounding JSON quotes and unescape newlines
          RAW_ESCAPED=${RAW_MESSAGE#\"}
          RAW_ESCAPED=${RAW_ESCAPED%\"}
          MESSAGE=$(printf '%b' "$RAW_ESCAPED")
          URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          # Strip surrounding JSON quotes
          # Build JSON payload with full description
          PAYLOAD=$(jq -nc \
            --arg username "GitBook" \
            --arg title "Building Guide Update" \
            --arg url "$URL" \
            --arg desc "$MESSAGE" \
            '{"username":$username,"embeds":[{"title":$title,"url":$url,"description":$desc,"color":3066993}]}')
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"